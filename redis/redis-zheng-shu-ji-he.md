# redis整数集合

整数集合(intset)是集合键的底层实现之一，当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis就会使用整数集合作为集合键的底层实现。

## 整数集合的实现

整数集合(intset)是Redis用于保存整数值的集合抽象数据结构，它可以保存类型为int16\_t、int32\_t或者int64\_t的整数值，并且保证集合中不会出现重复元素。

```c
typedef struct intset {
	// 编码方式
  	uint32_t encoding;
  	// 集合包含的元素数量
  	uint32_t length;
  	// 保存元素的数组
  	int8_t contents[];
} intset;
```

contents数组是整数集合的底层实现：整数集合的每个元素都是contents数组的一个数组项(item)，各个项在数组中按值的大小从小到大有序地排列，并且数组中不包含任何重复项。

length属性记录了整个集合包含的元素数量，也即是contents数组的长度。

虽然intset 结构将contents申明为int8\_t类型的数组，但实际上contents数组并不保存任何int8\_t类型的值，contents数组的真正类型取决于encoding属性的值。

### 升级

每当我们要将一个新元素添加到整数集合里面，并且新元素的类型比整数集合现有的所有元素类型都要长时，整数集合需要先进行升级(upgrade)，然后才能将新元素添加到集合里面。升级整数集合并添加新元素共分为三步进行：

1. 根据新元素的类型，扩展整数集合底层数组的空间大小。
2. 将底层数组现有的所有元素都转换成语新元素相同的类型，并将类型转换后的元素放置到正确的位置上，而且放置的过程中，需要继续维持底层数组的有序性质不变。
3. 将新元素添加到底层素组里面。

升级之后新元素的摆放位置：因为引发升级的新元素的长度总是比整数集合现有的所有元素的长度都大，所以新元素的值要么大于所有现有元素，要么小于所有现有元素。

* 在新元素小于所有元素的情况下，新元素会被放置在底层数组的最开头。
* 在新元素大于所有现有元素的情况下，新元素会被放置在底层数组的最末尾。

### 升级的好处

#### 提升灵活性

因为C语言是静态类型语言，为了避免升级，我们通常不会将两种不同类型的值放在同一个数据结构里面。但是因为整数集合可以通过自动升级底层数组来适应新元素，所以我们可以随意的将int16\_t、int32\_t或者int64\_t类型的整数添加到集合中，而不必担心出现类型错误，这种做法非常灵活。

#### 节约内存

### 降级

整数集合不支持降级操作，一旦对数组进行了升级，编码会一直保持升级后的状态。

## 整数集合API

* intsetNew：创建一个新的整数集合，O(1)
* intsetAdd：将给定元素添加到整数集合里面，O(N)
* intsetRemove：从整数集合中移除给定元素，O(N)
* intsetFind：检查给定值是否存在于集合，O(logN)
* intsetRandom：从整数集合中随机返回一个元素，O(1)
* intsetGet：去除底层数组在索引上的元素，O(1)
* intsetLen：返回整数集合中包含的元素个数，O(1)
* intsetBlobLen：返回整数集合占用的内存字节数，O(1)
