# redis跳跃表

跳跃表(skiplist)是一种有序数据结构，他通过在每个节点维持多个指向其他节点的指针，从来打到快速访问节点的目的。

跳跃表支持平均O(logN)、最坏O(N)复杂度的节点查找，还可以通过顺序性操作来批量处理节点。

在大部分情况下，跳跃表的效率可以和平衡树媲美，并且因为跳跃表的实现比平衡树更为简单，所以有不少程序都使用跳跃表来代替平衡树。

Redis使用跳跃表作为有序结合键的底层实现之一，如果一个有序集合包含的元素数量比较多，又或者有序集合中的成员(member)是比较长的字符串，Redis机会使用跳跃表来作为有序集合键的底层实现。和链表、字典等数据结构被广泛应用在Redis内部不同，Redis只在两个地方泳道了跳跃表，一个是实现有序集合键，另一个是在集群节点中用作内部数据结构。

## 跳跃表的实现

### 跳跃表节点

```c
typedef struct zskiplistNode {
    // 层
  	struct zskiplistLevel {
        // 前进指针
      	struct zskiplistNode *forward;
      	// 跨度
      	unsigned int span;
    } level[];
  	// 后退指针
  	struct zskiplistNode *backward;
  	// 分值
  	double score;
  	// 成员对象
  	robj *obj;
} zskiplistNode;
```

#### 层

跳跃表节点的level数据可以包含多个元素，每个元素都包含一个指向其他节点的指针，程序可以通过这些层来加快访问其他节点的速度，一般来说，层的数量越多，访问其他节点的速度就越快。每次创建一个新跳跃表的时候，程序都根据幂次定律(power law，越大的数出现的概率越小)随机生成一个介于1和32之间的level数组的大小，这个大小就是层的高度。

#### 前进指针

每个层都有一个指向表尾方向的前进指针(level\[i].forward)属性，用于从表尾方向访问节点。

#### 跨度

层的跨度(level\[i].span属性)用于记录两个节点之间的距离：

* 两个节点之间的跨度越大，他们相距的就越远。
* 指向NULL的所有前进指针的跨度都为0，因为它们没有连向任何节点。

#### 后退指针

节点的后退指针(backward属性)用于从表尾指向表头方向访问节点：跟可以一次跳过多个节点的前进指针不同，因为每个节点只有一个后退指针，所以每次只能后退至前一个节点。

#### 分值和成员

节点的分值(score属性)是一个double类型的浮点数，跳跃表中的所有节点都按照分值从小到大来排序。

节点的成员对象(obj属性)是一个指针，它指向一个字符串对象，而字符串对象则保存着一个SDS值。

在同一个跳跃表中，各个节点保存的成员对象必须是唯一的，但是多个节点保存的分值却是可以相同的：分值相同的节点将按照成员对象在字典序中的大小来进行排序，成员对象教小的节点会排在前面(靠近表头的方向)。

### 跳跃表

仅靠多个跳跃表节点就可以组成一个跳跃表，但是通过一个zskiplist结构来持有这些节点，程序可以更方便的对整个跳跃表进行处理，比如快速访问跳跃表的头结点和尾节点，或者快速地获取跳跃表节点的数量。

```c
typedef struct zskiplist {
    // 头节点和尾节点
  	struct zskiplistNode *header, *tail;
  	// 表中层数最大的节点的层数	
  	int level;
  	// 节点数量
  	unsigned int length;
} zskiplist;
```

header和tail指针分别指向跳跃表的表头和表尾节点，通过这两个指针，程序定位表头和表尾节点的复杂度为O(1)。

通过使用length属性来记录节点的数量，程序可以在O(1)复杂度内返回跳跃表的长度。

level属性则用于在O(1)复杂度内获取跳跃表中层高最大的那个节点的层数量，注意表头节点的层高并不计算在内。

## 跳跃表API

* zslCreate：创建一个新的跳跃表，O(1)
* zslFree：释放给定跳跃表，以及表中包含的所有节点，O(N)
* zslInsert：将包含给定增员和分支的新节点添加到跳跃表中，平均O(logN)、最坏O(N)
* zslDelete：删除跳跃表中包含给定成员和分值的节点，平均O(logN)、最坏O(N)
* zslGetRank：返回包含给定成员和分支的节点在跳跃表中的排位，平均O(logN)、最坏O(N)
* zslGetElementByRank：返回跳跃表在给定排位上的节点，平均O(logN)、最坏O(N)
* zslIsInRange：给定一个分值范围，比如0到15，20到28，如果跳跃表中至少有一个节点的分支在这个范围内，那么返回1，否则返回0，平均O(logN)、最坏O(N)
* zslFirstInRange：给定一个分支范围，返回跳跃表中第一个符合这个范围的节点，平均O(logN)、最坏O(N)
* zslLastInRange：给定一个分支范围，返回跳跃表中最后一个符合这个范围的节点，平均O(logN)、最坏O(N)
* zslDeleteRangeScore：给定一个分值范围，删除跳跃表中所有在这个范围之内的节点，O(N)
* zslDeleteRangeByRank：得定一个排位范围，删除跳跃表中所有在这个范围内的节点，O(N)
